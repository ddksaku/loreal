if object_id('up_createSnapshot') > 0
	drop procedure [up_createSnapshot]
go


CREATE PROCEDURE [dbo].[up_createSnapshot] (@animationID uniqueidentifier, @name nvarchar(50) = NULL, @comments nvarchar(1000) = NULL, @createdBy nvarchar(50) = NULL)
AS

declare @versionID uniqueidentifier
declare @animationStatus int
declare @animationName nvarchar(100)
set @versionID = NEWID()
select @animationStatus = [Status], @animationName = [Name] FROM dbo.Animation WHERE ID = @animationID
SET @animationName = @animationName + '_snapshot_' + convert(varchar,getdate(),20)

INSERT INTO dbo.Version (ID, IDAnimation, AnimationStatus, [Name], DateCreated, CreatedBy, Comments, ModifiedBy, ModifiedDate)
VALUES(@versionId, @animationID, @animationStatus, ISNULL(@name, @animationName), getdate(), ISNULL(@createdBy,'create snaphsot procedure'), @comments, @comments, getdate())


INSERT INTO [VersionSnapshot]
           ([IDVersion]
           ,[Division_Name]
           ,[Division_ID]
           ,[SalesDrive_Name]
           ,[SalesDrive_Year]
           ,[Animation_ID]
           ,[Animation_Name]
           ,[Animation_Code]
           ,[Animation_SAPDespatchCode]
           ,[Animation_DefaultCustomerReference]
           ,[Animation_Status]
           ,[Animation_RequestedDeliveryDate]
           ,[Priority_Name]
           ,[Priority_ID]
           ,[AnimationType_Name]
           ,[AnimationType_ID]
           ,[Animation_OnCounterDate]
           ,[Animation_PLVDeliveryDate]
           ,[Animation_PLVComponentDate]
           ,[Animation_StockDate]
           ,[ItemGroup_Name]
           ,[ItemGroup_ID]
           ,[ItemType_Name]
           ,[ItemType_ID]
           ,[Signature_Name]
           ,[Signature_ID]
           ,[BrandAxe_Name]
           ,[BrandAxe_ID]
           ,[Category_Name]
           ,[Category_ID]
           ,[AnimationProduct_OnCAS]
           ,[MultipleNormal]
           ,[MultipleWarehouse]
           ,[AnimationProduct_ConfirmedMADMonth]
           ,[AnimationProduct_StockRisk]
           ,[AnimationProduct_DeliveryRisk]
           ,[AnimationProduct_LogisticsComments]
           ,[Product_ID]
           ,[Product_MaterialCode]
           ,[Product_Description]
           ,[AnimationProduct_BDCBookNumber]
           ,[AnimationProduct_SortOrder]
           ,[Product_InternationalCode]
           ,[Product_EAN]
           ,[Product_Status]
           ,[Product_Manual]
           ,[ItemType_IncludeInOrders]
           ,[Product_ProcurementType]
           ,[Product_Stock]
           ,[Product_StockLessPipe]
           ,[AnimationProduct_ID]
           ,[TotalCapacity]
           ,[TotalBDCQuantity]
           ,[TotalForecastQuantity]
           ,[TotalAllocation]
           ,[TotalCIV]
           ,[Product_InTransit]
           ,[Product_Confirmed]
           ,[Product_Reliquat]
           ,[Product_MonthDeleveryCurrent]
           ,[Product_MonthDelevery1]
           ,[Product_MonthDelevery2]
           ,[Product_MonthDelevery3]
           ,[Product_MonthDelevery4]
           ,[Product_MonthDelevery5]
           ,[Product_MonthDelevery6]
           ,[Product_MonthDelevery7]
           ,[Product_MonthDelevery8]
           ,[Product_MonthDelevery9]
           ,[Product_MonthDelevery10]
           ,[Product_MonthDelevery11]
           ,[Product_ReceivedToDate]
           ,[SalesArea_SalesOrganizationName]
           ,[SalesArea_DistributionChannelName]
           ,[SalesArea_DivisionName]
           ,[SalesArea_Name]
           ,[SalesArea_Code]
           ,[AnimationProductDetail_ID]
           ,[AnimationProductDetail_RRP]
           ,RrpUK
           ,RrpROI
           ,[ListPriceUK]
           ,[ListPriceROI]
           ,[Product_CostPrice]
           ,[AnimationProductDetail_CostValue]
           ,[AnimationProductDetail_BDCQuantity]
           ,[AnimationProductDetail_ForecastProcQuantity]
           ,[AnimationProductDetail_AllocationQuantity]
           ,[AnimationProductDetail_MarketingComments]
           ,[AnimationProductDetail_TotalCapacity]
           ,[AnimationProductDetail_AllocationRemainder]
           ,[CustomerGroup_ID]
           ,[CustomerGroup_Name]
           ,[CustomerGroup_Code]
           ,[CustomerGroup_SalesArea]
           ,[CustomerGroup_SalesAreaID]
           ,[CustomerGroup_RetailUplift]
           ,[CustomerGroup_ManualFixed]
           ,[CustomerGroup_SystemFixed]
           ,[CustomerGroup_CalculatedAllocation]
           ,[CustomerGroup_TotalCapacity]
           ,[CustomerGroup_SaleData]
           ,[CustomerGroup_SaleDataMinimumDate]
           ,[CustomerGroup_SaleDataMaximumDate]
           ,[Customer_SalesEmployeeName]
           ,[Customer_SalesEmployeeID]
           ,[Customer_SalesAreaName]
           ,[Customer_SalesAreaID]
           ,[Customer_AccountNumber]
           ,[Customer_Name]
           ,[Customer_FixedAllocation]
           ,[Customer_RetailUplift]
           ,[Customer_CalculatedAllocation]
           ,[Customer_Capacity]
           ,[Customer_ID]
           ,[Customer_SaleData]
           ,[Customer_SaleDataMinimumDate]
           ,[Customer_SaleDataMaximumDate]
           ,[ModifiedBy]
           ,[ModifiedDate]
           ,OnCounterDate)
      SELECT @versionID, 
         [Division_Name]
      ,[Division_ID]
      ,[SalesDrive_Name]
      ,[SalesDrive_Year]
      ,[Animation_ID]
      ,[Animation_Name]
      ,[Animation_Code]
      ,[Animation_SAPDespatchCode]
      ,[Animation_DefaultCustomerReference]
      ,[Animation_Status]
      ,[Animation_RequestedDeliveryDate]
      ,[Priority_Name]
      ,[Priority_ID]
      ,[AnimationType_Name]
      ,[AnimationType_ID]
      ,[Animation_OnCounterDate]
      ,[Animation_PLVDeliveryDate]
      ,[Animation_PLVComponentDate]
      ,[Animation_StockDate]
      ,[ItemGroup_Name]
      ,[ItemGroup_ID]
      ,[ItemType_Name]
      ,[ItemType_ID]
      ,[Signature_Name]
      ,[Signature_ID]
      ,[BrandAxe_Name]
      ,[BrandAxe_ID]
      ,[Category_Name]
      ,[Category_ID]
      ,[AnimationProduct_OnCAS]
      ,[MultipleNormal]
      ,[MultipleWarehouse]
      ,[AnimationProduct_ConfirmedMADMonth]
      ,[AnimationProduct_StockRisk]
      ,[AnimationProduct_DeliveryRisk]
      ,[AnimationProduct_LogisticsComments]
      ,[Product_ID]
      ,[Product_MaterialCode]
      ,[Product_Description]
      ,[AnimationProduct_BDCBookNumber]
      ,[AnimationProduct_SortOrder]
      ,[Product_InternationalCode]
      ,[Product_EAN]
      ,[Product_Status]
      ,[Product_Manual]
      ,[ItemType_IncludeInOrders]
      ,[Product_ProcurementType]
      ,[Product_Stock]
      ,[Product_StockLessPipe]
      ,[AnimationProduct_ID]
      ,[TotalCapacity]
      ,[TotalBDCQuantity]
      ,[TotalForecastQuantity]
      ,[TotalAllocation]
      ,[TotalCIV]
      ,[Product_InTransit]
      ,[Product_Confirmed]
      ,[Product_Reliquat]
      ,[Product_MonthDeleveryCurrent]
      ,[Product_MonthDelevery1]
      ,[Product_MonthDelevery2]
      ,[Product_MonthDelevery3]
      ,[Product_MonthDelevery4]
      ,[Product_MonthDelevery5]
      ,[Product_MonthDelevery6]
      ,[Product_MonthDelevery7]
      ,[Product_MonthDelevery8]
      ,[Product_MonthDelevery9]
      ,[Product_MonthDelevery10]
      ,[Product_MonthDelevery11]
      ,[Product_ReceivedToDate]
      ,[SalesArea_SalesOrganizationName]
      ,[SalesArea_DistributionChannelName]
      ,[SalesArea_DivisionName]
      ,[SalesArea_Name]
      ,[SalesArea_Code]
      ,[AnimationProductDetail_ID]
      ,[AnimationProductDetail_RRP]
      ,RrpUK
      ,RrpROI
      ,[ListPriceUK]
      ,[ListPriceROI]
      ,[Product_CostPrice]
      ,[AnimationProductDetail_CostValue]
      ,[AnimationProductDetail_BDCQuantity]
      ,[AnimationProductDetail_ForecastProcQuantity]
      ,[AnimationProductDetail_AllocationQuantity]
      ,[AnimationProductDetail_MarketingComments]
      ,[AnimationProductDetail_TotalCapacity]
      ,[AnimationProductDetail_AllocationRemainder]
      ,[CustomerGroup_ID]
      ,[CustomerGroup_Name]
      ,[CustomerGroup_Code]
      ,[CustomerGroup_SalesArea]
      ,[CustomerGroup_SalesAreaID]
      ,[CustomerGroup_RetailUplift]
      ,[CustomerGroup_ManualFixed]
      ,[CustomerGroup_SystemFixed]
      ,[CustomerGroup_CalculatedAllocation]
      ,[CustomerGroup_TotalCapacity]
      ,[CustomerGroup_SaleData]
      ,[CustomerGroup_SaleDataMinimumDate]
      ,[CustomerGroup_SaleDataMaximumDate]
      ,[Customer_SalesEmployeeName]
      ,[Customer_SalesEmployeeID]
      ,[Customer_SalesAreaName]
      ,[Customer_SalesAreaID]
      ,[Customer_AccountNumber]
      ,[Customer_Name]
      ,[Customer_FixedAllocation]
      ,[Customer_RetailUplift]
      ,[Customer_CalculatedAllocation]
      ,[Customer_Capacity]
      ,[Customer_ID]
      ,[Customer_SaleData]
      ,[Customer_SaleDataMinimumDate]
      ,[Customer_SaleDataMaximumDate]
        ,'create snapshot procedure'
        ,getdate()
        ,OnCounterDate
  FROM [dbo].[v_snapshot]
            WHERE Animation_ID = @animationID
     

